<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medication Lookup App</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f3f4f6;
      min-height: 100vh;
      padding: 1rem;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    h1 {
      font-size: 2rem;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 1.5rem;
    }
    h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1rem;
    }
    h3 {
      font-size: 1.125rem;
      font-weight: 600;
      color: #2563eb;
      margin-bottom: 0.5rem;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    @media (min-width: 768px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }
    select, input[type="file"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 1rem;
    }
    select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    select:disabled {
      background-color: #f3f4f6;
      cursor: not-allowed;
    }
    .file-upload {
      border: 2px dashed #d1d5db;
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    .file-input-label {
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: #eff6ff;
      color: #2563eb;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: 600;
      margin-top: 0.5rem;
    }
    .file-input-label:hover {
      background-color: #dbeafe;
    }
    input[type="file"] {
      display: none;
    }
    .medication-card {
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      transition: box-shadow 0.2s;
    }
    .medication-card:hover {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .medication-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }
    @media (min-width: 768px) {
      .medication-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    .info-box {
      padding: 0.75rem;
      border-radius: 0.375rem;
      margin-bottom: 0.75rem;
    }
    .info-box.dosing {
      background-color: #fef3c7;
    }
    .info-box.description {
      background-color: #f9fafb;
    }
    .loading {
      text-align: center;
      padding: 2rem;
    }
    .spinner {
      display: inline-block;
      width: 3rem;
      height: 3rem;
      border: 3px solid #e5e7eb;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .text-muted {
      color: #6b7280;
    }
    .text-sm {
      font-size: 0.875rem;
    }
    .font-medium {
      font-weight: 500;
    }
    .alert {
      padding: 1rem;
      background-color: #fef3c7;
      border-radius: 0.5rem;
      margin-top: 1.5rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/javascript">
    const { useState, useEffect } = React;
    const { createRoot } = ReactDOM;

    const STATES = [
      'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut', 'Delaware',
      'District of Columbia', 'Florida', 'Georgia', 'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa',
      'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota',
      'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire', 'New Jersey', 'New Mexico',
      'New York', 'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania', 'Puerto Rico',
      'Rhode Island', 'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont', 'Virginia',
      'Washington', 'West Virginia', 'Wisconsin', 'Wyoming', 'Virgin Islands'
    ];

    const PATIENT_GOALS = [
      'Men - Standard TRT Protocol',
      'Men - Standard Add On',
      'Women - Standard HRT Protocol',
      'Women - Standard Add On',
      'Joint Pain/Healing',
      'Sexual Function',
      'Vitamins',
      'Hair Loss',
      'Improve Energy',
      'Anti-Aging',
      'Improve Sleep',
      'Weight Loss'
    ];

    const SHIPMENT_MAP = {
      'Alabama': { Hallandale: false, 'First Choice': true, RiteAway: false, Revive: false, NuBioage: false, ScriptWorks: false },
      'Alaska': { Hallandale: false, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: false, ScriptWorks: false },
      'Arizona': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Arkansas': { Hallandale: false, 'First Choice': true, RiteAway: false, Revive: false, NuBioage: false, ScriptWorks: false },
      'California': { Hallandale: false, 'First Choice': false, RiteAway: false, Revive: false, NuBioage: false, ScriptWorks: true },
      'Colorado': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: false, NuBioage: true, ScriptWorks: false },
      'Connecticut': { Hallandale: false, 'First Choice': true, RiteAway: true, Revive: false, NuBioage: true, ScriptWorks: false },
      'Delaware': { Hallandale: true, 'First Choice': false, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'District of Columbia': { Hallandale: true, 'First Choice': false, RiteAway: true, Revive: false, NuBioage: true, ScriptWorks: false },
      'Florida': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Georgia': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Hawaii': { Hallandale: false, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Idaho': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Illinois': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Indiana': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Iowa': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: false, NuBioage: false, ScriptWorks: false },
      'Kansas': { Hallandale: false, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Kentucky': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: false, NuBioage: true, ScriptWorks: false },
      'Louisiana': { Hallandale: true, 'First Choice': false, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Maine': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: false, ScriptWorks: false },
      'Maryland': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Massachusetts': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: false, NuBioage: true, ScriptWorks: false },
      'Michigan': { Hallandale: false, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Minnesota': { Hallandale: false, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Mississippi': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: false, NuBioage: false, ScriptWorks: false },
      'Missouri': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Montana': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Nebraska': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Nevada': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'New Hampshire': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'New Jersey': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'New Mexico': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'New York': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'North Carolina': { Hallandale: true, 'First Choice': false, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'North Dakota': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Ohio': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Oklahoma': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Oregon': { Hallandale: false, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Pennsylvania': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Puerto Rico': { Hallandale: true, 'First Choice': false, RiteAway: false, Revive: false, NuBioage: true, ScriptWorks: false },
      'Rhode Island': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'South Carolina': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: false, NuBioage: false, ScriptWorks: false },
      'South Dakota': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Tennessee': { Hallandale: false, 'First Choice': false, RiteAway: false, Revive: false, NuBioage: false, ScriptWorks: false },
      'Texas': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Utah': { Hallandale: true, 'First Choice': false, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Vermont': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: false, NuBioage: true, ScriptWorks: false },
      'Virginia': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Washington': { Hallandale: true, 'First Choice': false, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'West Virginia': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Wisconsin': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Wyoming': { Hallandale: true, 'First Choice': false, RiteAway: true, Revive: false, NuBioage: false, ScriptWorks: false },
      'Virgin Islands': { Hallandale: false, 'First Choice': false, RiteAway: false, Revive: false, NuBioage: false, ScriptWorks: false }
    };

    function getMedicationDescription(medication) {
      const descriptions = {
        'testosterone cypionate': 'Used for TRT to treat low testosterone. Improves energy, muscle, libido. Side effects: acne, hair loss, mood changes.',
        'testosterone enanthate': 'Long-acting testosterone for HRT. Similar to cypionate. Side effects: acne, hair loss, mood changes.',
        'anastrozole': 'Reduces estrogen in TRT patients. Prevents gynecomastia. Side effects: joint pain, hot flashes.',
        'bi-estrogen': 'HRT for menopause symptoms like hot flashes. Side effects: weight gain, blurred vision, tiredness, acne.',
        'progesterone': 'Supports hormonal balance in HRT. Improves sleep, mood. Side effects: abdominal pain, bloating, blurred vision, nausea.',
        'clomiphene': 'Stimulates testosterone in men or ovulation in women. Side effects: hot flashes, headaches.',
        'clomid': 'Same as Clomiphene. Stimulates hormone production. Side effects: hot flashes, headaches.',
        'estrogen patch': 'HRT for menopause. Reduces hot flashes, vaginal dryness. Side effects: bloating, breast tenderness, headaches, nausea.',
        'dhea': 'Supports hormone production. May improve energy, mood. Side effects: oily skin, acne, hair loss, upset stomach.',
        'pregnenolone': 'Precursor hormone for others. May aid memory, mood. Side effects: overstimulation, insomnia, irritability, acne, headache.',
        'nandrolone': 'For joint pain, muscle wasting. Relieves hypogonadal joint pain. Side effects: headaches, acne, diarrhea, edema.',
        'l carnitine': 'Aids fat burning, energy. For healing, performance. Side effects: stomach upset, heartburn, diarrhea, seizures.',
        'sermorelin': 'Stimulates growth hormone release. Anti-aging, energy. Side effects: injection site reactions, headache, flushing, nausea.',
        'cjc 1295': 'Boosts GH for muscle, fat loss. Side effects: headaches, flu-like symptoms, irritability, nausea.',
        'ipamorelin': 'Growth hormone peptide. Works with CJC 1295. Side effects: headaches, flu-like symptoms.',
        'bpc': 'Promotes healing, wound repair. For tendons, ligaments. Side effects: unknown in humans, potential injection reactions.',
        'tb500': 'Aids tissue repair, flexibility. Side effects: fatigue, headaches, dizziness, injection site irritation.',
        'tb4': 'Same as TB500. Thymosin Beta 4 for healing.',
        'sildenafil': 'Treats ED by increasing blood flow. Side effects: headache, flushing, nausea, stuffy nose.',
        'viagra': 'Brand name for Sildenafil. Treats ED. Side effects: headache, flushing, nausea.',
        'tadalafil': 'Treats ED, longer-lasting. Side effects: headache, flushing, back pain, nausea.',
        'cialis': 'Brand name for Tadalafil. Long-lasting ED treatment.',
        'pt 141': 'Boosts libido, arousal. Side effects: nausea (common), vomiting, flushing, headache.',
        'bremelanotide': 'Same as PT 141. Enhances sexual desire.',
        'oxytocin': 'Enhances bonding, may aid sexual function. Side effects: headache, nausea, vomiting, rapid heartbeat.',
        'scream cream': 'Topical for female arousal. Side effects: itching, redness, dryness, dizziness, headaches.',
        'glutathione': 'Antioxidant for detox, skin. Side effects: rash (topical), nausea, abdominal cramps (injections).',
        'lipo b': 'Fat-burning injection with B vitamins. Side effects: allergic reactions, anxiety, constipation, diarrhea.',
        'mic b12': 'Weight loss blend with B12. Side effects: pain at site, nausea, vomiting, diarrhea.',
        'bioboost': 'Energy and metabolism support. Contains B vitamins.',
        'vitamin b12': 'For energy, deficiency. Side effects: mild diarrhea, itching, swelling sensation.',
        'lipo c': 'Lipotropic for fat loss. Side effects: pain/swelling at site, nausea, gastrointestinal issues.',
        'finasteride': 'For hair loss. Blocks DHT. Side effects: sexual dysfunction, depression.',
        'minoxidil': 'For hair loss. Promotes growth. Side effects: itching, scalp irritation.',
        'metformin': 'Blood sugar control for weight loss. Side effects: nausea, diarrhea, stomach upset.',
        'phentermine': 'Appetite suppressant. Side effects: dry mouth, insomnia, increased heart rate.',
        'semaglutide': 'GLP-1 for weight loss. Side effects: nausea, vomiting, diarrhea.',
        'tirzepatide': 'Dual GIP/GLP-1 for weight loss. Side effects: nausea, decreased appetite.',
        'melatonin': 'Sleep hormone supplement. Side effects: drowsiness, headache, dizziness.',
        'trazodone': 'Sleep aid, antidepressant. Side effects: drowsiness, dry mouth, dizziness.',
        'hcg': 'Human chorionic gonadotropin. Stimulates testosterone. Side effects: headache, irritability, fatigue.',
        'gonadorelin': 'Stimulates LH/FSH release. Alternative to HCG. Side effects: injection site reactions.',
        'enclomiphene': 'Selective estrogen receptor modulator. Boosts testosterone. Side effects: hot flashes, headaches.',
        'tamoxifen': 'SERM for estrogen blocking. Side effects: hot flashes, nausea.',
        'exemestane': 'Aromatase inhibitor. Reduces estrogen. Side effects: joint pain, fatigue.',
        'letrozole': 'Aromatase inhibitor. Very potent. Side effects: joint pain, hot flashes.',
        'cabergoline': 'Dopamine agonist. Reduces prolactin. Side effects: nausea, dizziness.',
        'kyzatrex': 'Oral testosterone undecanoate. Alternative to injections. Side effects: similar to other testosterone.',
        'pregnyl': 'Brand name for HCG. Used in fertility and testosterone support.'
      };

      if (!medication) return 'Medication information not available.';
      
      const medLower = medication.toLowerCase();
      
      for (const [key, desc] of Object.entries(descriptions)) {
        if (medLower.includes(key)) {
          return desc;
        }
      }
      
      if (medLower.includes('testosterone')) {
        return 'Testosterone replacement therapy. Side effects: acne, hair loss, mood changes.';
      }
      if (medLower.includes('estrogen') || medLower.includes('bi-est')) {
        return 'Estrogen hormone replacement. Side effects: bloating, breast tenderness.';
      }
      if (medLower.includes('vitamin') || medLower.includes('b12')) {
        return 'Vitamin supplementation for energy and health.';
      }
      
      return 'Medication information not available. Please consult your healthcare provider.';
    }

    function parseMedications(csvData, isCA = false) {
      const lines = csvData.split('\n').map(line => line.trim()).filter(line => line);
      const medications = [];
      let currentCategory = null;
      let headerIndices = null;
      
      for (let i = 0; i < lines.length; i++) {
        const parsed = Papa.parse(lines[i], { 
          dynamicTyping: true,
          skipEmptyLines: true 
        });
        
        if (parsed.data.length === 0) continue;
        
        const row = parsed.data[0];
        
        if (!row || row.every(cell => !cell)) continue;
        
        const firstCell = String(row[0] || '');
        
        // Check if this is a category header
        if (PATIENT_GOALS.some(goal => firstCell.includes(goal))) {
          currentCategory = PATIENT_GOALS.find(goal => firstCell.includes(goal));
          continue;
        }
        
        // Check if this is the header row
        if (firstCell === 'Medication' || firstCell.toLowerCase().includes('medication')) {
          headerIndices = {
            medication: 0,
            syringes: row.findIndex(h => h && String(h).toLowerCase().includes('syringe')),
            delivery: row.findIndex(h => h && (String(h).toLowerCase().includes('delivery') || String(h).toLowerCase() === 'type')),
            strength: row.findIndex(h => h && String(h).toLowerCase().includes('strength')),
            quantity: row.findIndex(h => h && String(h).toLowerCase().includes('quantity')),
            price: row.findIndex(h => h && String(h).toLowerCase().includes('price')),
            duration: row.findIndex(h => h && String(h).toLowerCase().includes('duration')),
            pharmacy: row.findIndex(h => h && String(h).toLowerCase().includes('pharmacy')),
            remarksDosing: row.findIndex(h => h && (String(h).toLowerCase().includes('remark') || String(h).toLowerCase().includes('dosing'))),
            description: row.findIndex(h => h && String(h).toLowerCase().includes('description'))
          };
          continue;
        }
        
        if (!currentCategory || !headerIndices) continue;
        
        // Skip rows that look like sub-headers or notes
        if (firstCell.toLowerCase().includes('note') || 
            firstCell.toLowerCase().includes('standard add on') ||
            firstCell === '$100 CONSULT FEE' ||
            row.filter(cell => cell).length < 2) {
          continue;
        }
        
        // Parse medication row
        if (firstCell && firstCell.trim()) {
          const med = {
            category: currentCategory,
            medication: firstCell.trim(),
            syringes: headerIndices.syringes >= 0 ? String(row[headerIndices.syringes] || '') : '',
            delivery: headerIndices.delivery >= 0 ? String(row[headerIndices.delivery] || '') : '',
            strength: headerIndices.strength >= 0 ? String(row[headerIndices.strength] || '') : '',
            quantity: headerIndices.quantity >= 0 ? String(row[headerIndices.quantity] || '') : '',
            price: headerIndices.price >= 0 ? String(row[headerIndices.price] || '') : '',
            duration: headerIndices.duration >= 0 ? String(row[headerIndices.duration] || '') : '',
            pharmacy: headerIndices.pharmacy >= 0 ? String(row[headerIndices.pharmacy] || '') : '',
            remarksDosing: headerIndices.remarksDosing >= 0 ? String(row[headerIndices.remarksDosing] || '') : '',
            description: headerIndices.description >= 0 ? String(row[headerIndices.description] || '') : getMedicationDescription(firstCell.trim()),
            isCA: isCA
          };
          
          if (!med.description || med.description === 'null' || med.description === '') {
            med.description = getMedicationDescription(med.medication);
          }
          
          medications.push(med);
        }
      }
      
      return medications;
    }

    function App() {
      const [medications, setMedications] = useState([]);
      const [caMedications, setCaMedications] = useState([]);
      const [selectedState, setSelectedState] = useState('');
      const [selectedGoal, setSelectedGoal] = useState('');
      const [loading, setLoading] = useState(false);
      const [dataLoaded, setDataLoaded] = useState(false);
      const [filteredMedications, setFilteredMedications] = useState([]);

      const handleFileUpload = (event, fileType) => {
        const file = event.target.files[0];
        if (!file) return;

        setLoading(true);
        const reader = new FileReader();
        
        reader.onload = (e) => {
          const content = e.target.result;
          
          if (fileType === 'viking') {
            const meds = parseMedications(content, false);
            setMedications(meds);
          } else if (fileType === 'ca') {
            const meds = parseMedications(content, true);
            setCaMedications(meds);
          }
          
          if ((fileType === 'viking' && caMedications.length > 0) || 
              (fileType === 'ca' && medications.length > 0)) {
            setDataLoaded(true);
          }
          
          setLoading(false);
        };
        
        reader.readAsText(file);
      };

      useEffect(() => {
        if (!selectedState || !selectedGoal) {
          setFilteredMedications([]);
          return;
        }
        
        const medList = selectedState === 'California' ? caMedications : medications;
        
        let filtered = medList.filter(med => med.category === selectedGoal);
        
        if (selectedState !== 'California') {
          const stateShipping = SHIPMENT_MAP[selectedState] || {};
          
          filtered = filtered.filter(med => {
            if (!med.pharmacy || med.pharmacy === 'null' || med.pharmacy.trim() === '') {
              return Object.values(stateShipping).some(ships => ships);
            }
            
            const pharmacies = med.pharmacy.split(',').map(p => p.trim());
            
            if (med.medication.toLowerCase().includes('hcg') || 
                med.medication.toLowerCase().includes('pregnyl') ||
                med.medication.toLowerCase().includes('gonadorelin')) {
              return stateShipping['RiteAway'] || stateShipping['Revive'];
            }
            
            return pharmacies.some(pharmacy => {
              if (pharmacy.includes('Hallandale')) return stateShipping['Hallandale'];
              if (pharmacy.includes('First Choice') || pharmacy.includes('1st Choice')) return stateShipping['First Choice'];
              if (pharmacy.includes('Rite Away') || pharmacy.includes('RiteAway')) return stateShipping['RiteAway'];
              if (pharmacy.includes('Revive')) return stateShipping['Revive'];
              if (pharmacy.includes('NuBioage') || pharmacy.includes('NuBiage')) return stateShipping['NuBioage'];
              
              return true;
            });
          });
        }
        
        setFilteredMedications(filtered);
      }, [selectedState, selectedGoal, medications, caMedications]);

      if (!dataLoaded) {
        return (
          <div className="container">
            <div className="card">
              <h1>Medication Lookup App</h1>
              
              <p className="text-muted" style={{ marginBottom: '1.5rem' }}>
                Please upload the medication CSV files to get started:
              </p>
              
              <div className="file-upload">
                <h3 style={{ color: '#374151', marginBottom: '0.5rem' }}>Non-California Medications</h3>
                <p className="text-sm text-muted">Upload "Viking Medication Converted to Standard Columns UTF.csv"</p>
                <label className="file-input-label">
                  Choose File
                  <input
                    type="file"
                    accept=".csv"
                    onChange={(e) => handleFileUpload(e, 'viking')}
                  />
                </label>
              </div>
              
              <div className="file-upload">
                <h3 style={{ color: '#374151', marginBottom: '0.5rem' }}>California Medications</h3>
                <p className="text-sm text-muted">Upload "ca_meds.csv" or "California Pricing and Products.csv"</p>
                <label className="file-input-label">
                  Choose File
                  <input
                    type="file"
                    accept=".csv"
                    onChange={(e) => handleFileUpload(e, 'ca')}
                  />
                </label>
              </div>
              
              {loading && (
                <div className="loading">
                  <div className="spinner"></div>
                  <p className="text-muted" style={{ marginTop: '0.5rem' }}>Processing file...</p>
                </div>
              )}
              
              <div className="alert">
                <p className="text-sm">
                  <strong>Note:</strong> The pharmacy shipping restrictions are already built into the app. 
                  You only need to upload the medication files.
                </p>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="container">
          <div className="card">
            <h1>Medication Lookup</h1>
            
            <div className="grid">
              <div>
                <label>Select State</label>
                <select
                  value={selectedState}
                  onChange={(e) => setSelectedState(e.target.value)}
                >
                  <option value="">Choose a state...</option>
                  {STATES.map(state => (
                    <option key={state} value={state}>{state}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label>Select Patient Goal</label>
                <select
                  value={selectedGoal}
                  onChange={(e) => setSelectedGoal(e.target.value)}
                  disabled={!selectedState}
                >
                  <option value="">Choose a goal...</option>
                  {PATIENT_GOALS.map(goal => (
                    <option key={goal} value={goal}>{goal}</option>
                  ))}
                </select>
              </div>
            </div>

            {selectedState && !selectedGoal && (
              <p className="text-muted">Please select a patient goal to view available medications.</p>
            )}
          </div>

          {filteredMedications.length > 0 && (
            <div className="card">
              <h2>Available Medications for {selectedGoal} in {selectedState}</h2>
              
              <div>
                {filteredMedications.map((med, index) => (
                  <div key={index} className="medication-card">
                    <h3>{med.medication}</h3>
                    
                    <div className="medication-grid">
                      <div>
                        {med.delivery && <p><span className="font-medium">Delivery:</span> {med.delivery}</p>}
                        {med.strength && <p><span className="font-medium">Strength:</span> {med.strength}</p>}
                        {med.quantity && <p><span className="font-medium">Quantity:</span> {med.quantity}</p>}
                        {med.price && <p><span className="font-medium">Price:</span> {med.price}</p>}
                      </div>
                      <div>
                        {med.duration && <p><span className="font-medium">Duration:</span> {med.duration}</p>}
                        {med.syringes && med.syringes !== 'null' && (
                          <p><span className="font-medium">Syringes:</span> {med.syringes}</p>
                        )}
                        {med.pharmacy && med.pharmacy !== 'null' && (
                          <p><span className="font-medium">Pharmacy:</span> {med.pharmacy}</p>
                        )}
                      </div>
                    </div>
                    
                    {med.remarksDosing && med.remarksDosing !== 'null' && (
                      <div className="info-box dosing">
                        <p className="font-medium">Dosing Instructions:</p>
                        <p className="text-muted">{med.remarksDosing}</p>
                      </div>
                    )}
                    
                    {med.description && (
                      <div className="info-box description">
                        <p className="font-medium">Description:</p>
                        <p className="text-muted">{med.description}</p>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          {selectedState && selectedGoal && filteredMedications.length === 0 && (
            <div className="card">
              <p style={{ textAlign: 'center' }} className="text-muted">
                No medications available for {selectedGoal} in {selectedState}. 
                This may be due to pharmacy shipping restrictions.
              </p>
            </div>
          )}
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>
</body>
</html>
