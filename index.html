<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medication Lookup App</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f3f4f6;
      min-height: 100vh;
      padding: 1rem;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    h1 {
      font-size: 2rem;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 1.5rem;
    }
    h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1rem;
    }
    h3 {
      font-size: 1.125rem;
      font-weight: 600;
      color: #2563eb;
      margin-bottom: 0.5rem;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    @media (min-width: 768px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }
    select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 1rem;
      background-color: white;
    }
    select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    select:disabled {
      background-color: #f3f4f6;
      cursor: not-allowed;
    }
    .file-upload {
      border: 2px dashed #d1d5db;
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    .file-input-label {
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: #eff6ff;
      color: #2563eb;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: 600;
      margin-top: 0.5rem;
    }
    .file-input-label:hover {
      background-color: #dbeafe;
    }
    input[type="file"] {
      display: none;
    }
    .medication-card {
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      transition: box-shadow 0.2s;
    }
    .medication-card:hover {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .medication-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }
    @media (min-width: 768px) {
      .medication-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    .info-box {
      padding: 0.75rem;
      border-radius: 0.375rem;
      margin-bottom: 0.75rem;
    }
    .info-box.dosing {
      background-color: #fef3c7;
    }
    .info-box.description {
      background-color: #f9fafb;
    }
    .text-muted {
      color: #6b7280;
    }
    .text-sm {
      font-size: 0.875rem;
    }
    .font-medium {
      font-weight: 500;
    }
    .alert {
      padding: 1rem;
      background-color: #fef3c7;
      border-radius: 0.5rem;
      margin-top: 1.5rem;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="upload-section" class="card">
      <h1>Medication Lookup App</h1>
      
      <p class="text-muted" style="margin-bottom: 1.5rem;">
        Please upload the medication CSV files to get started:
      </p>
      
      <div class="file-upload">
        <h3 style="color: #374151; margin-bottom: 0.5rem;">Non-California Medications</h3>
        <p class="text-sm text-muted">Upload "Viking Medication Converted to Standard Columns UTF.csv"</p>
        <label class="file-input-label">
          Choose File
          <input type="file" id="viking-file" accept=".csv">
        </label>
      </div>
      
      <div class="file-upload">
        <h3 style="color: #374151; margin-bottom: 0.5rem;">California Medications</h3>
        <p class="text-sm text-muted">Upload "ca_meds.csv" or "California Pricing and Products.csv"</p>
        <label class="file-input-label">
          Choose File
          <input type="file" id="ca-file" accept=".csv">
        </label>
      </div>
      
      <div class="alert">
        <p class="text-sm">
          <strong>Note:</strong> The pharmacy shipping restrictions are already built into the app. 
          You only need to upload the medication files.
        </p>
      </div>
    </div>

    <div id="lookup-section" class="hidden">
      <div class="card">
        <h1>Medication Lookup</h1>
        
        <div class="grid">
          <div>
            <label>Select State</label>
            <select id="state-select">
              <option value="">Choose a state...</option>
            </select>
          </div>
          
          <div>
            <label>Select Patient Goal</label>
            <select id="goal-select" disabled>
              <option value="">Choose a goal...</option>
            </select>
          </div>
        </div>

        <p id="select-goal-message" class="text-muted hidden">Please select a patient goal to view available medications.</p>
      </div>

      <div id="results-section" class="card hidden">
        <h2 id="results-header"></h2>
        <div id="medications-list"></div>
      </div>

      <div id="no-results" class="card hidden">
        <p style="text-align: center;" class="text-muted">
          No medications available for this combination. 
          This may be due to pharmacy shipping restrictions.
        </p>
      </div>
    </div>
  </div>

  <script>
    // Data constants
    const STATES = [
      'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut', 'Delaware',
      'District of Columbia', 'Florida', 'Georgia', 'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa',
      'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota',
      'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire', 'New Jersey', 'New Mexico',
      'New York', 'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania', 'Puerto Rico',
      'Rhode Island', 'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont', 'Virginia',
      'Washington', 'West Virginia', 'Wisconsin', 'Wyoming', 'Virgin Islands'
    ];

    const PATIENT_GOALS = [
      'Men - Standard TRT Protocol',
      'Men - Standard Add On',
      'Women - Standard HRT Protocol',
      'Women - Standard Add On',
      'Joint Pain/Healing',
      'Sexual Function',
      'Vitamins',
      'Hair Loss',
      'Improve Energy',
      'Anti-Aging',
      'Improve Sleep',
      'Weight Loss'
    ];

    const SHIPMENT_MAP = {
      'Alabama': { Hallandale: false, 'First Choice': true, RiteAway: false, Revive: false, NuBioage: false, ScriptWorks: false },
      'Alaska': { Hallandale: false, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: false, ScriptWorks: false },
      'Arizona': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Arkansas': { Hallandale: false, 'First Choice': true, RiteAway: false, Revive: false, NuBioage: false, ScriptWorks: false },
      'California': { Hallandale: false, 'First Choice': false, RiteAway: false, Revive: false, NuBioage: false, ScriptWorks: true },
      'Colorado': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: false, NuBioage: true, ScriptWorks: false },
      'Connecticut': { Hallandale: false, 'First Choice': true, RiteAway: true, Revive: false, NuBioage: true, ScriptWorks: false },
      'Delaware': { Hallandale: true, 'First Choice': false, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'District of Columbia': { Hallandale: true, 'First Choice': false, RiteAway: true, Revive: false, NuBioage: true, ScriptWorks: false },
      'Florida': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Georgia': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Hawaii': { Hallandale: false, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Idaho': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Illinois': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Indiana': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Iowa': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: false, NuBioage: false, ScriptWorks: false },
      'Kansas': { Hallandale: false, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Kentucky': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: false, NuBioage: true, ScriptWorks: false },
      'Louisiana': { Hallandale: true, 'First Choice': false, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Maine': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: false, ScriptWorks: false },
      'Maryland': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Massachusetts': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: false, NuBioage: true, ScriptWorks: false },
      'Michigan': { Hallandale: false, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Minnesota': { Hallandale: false, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Mississippi': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: false, NuBioage: false, ScriptWorks: false },
      'Missouri': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Montana': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Nebraska': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Nevada': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'New Hampshire': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'New Jersey': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'New Mexico': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'New York': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'North Carolina': { Hallandale: true, 'First Choice': false, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'North Dakota': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Ohio': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Oklahoma': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Oregon': { Hallandale: false, 'First Choice': true, RiteAway: false, Revive: true, NuBioage: true, ScriptWorks: false },
      'Pennsylvania': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Puerto Rico': { Hallandale: true, 'First Choice': false, RiteAway: false, Revive: false, NuBioage: true, ScriptWorks: false },
      'Rhode Island': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'South Carolina': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: false, NuBioage: false, ScriptWorks: false },
      'South Dakota': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Tennessee': { Hallandale: false, 'First Choice': false, RiteAway: false, Revive: false, NuBioage: false, ScriptWorks: false },
      'Texas': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Utah': { Hallandale: true, 'First Choice': false, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Vermont': { Hallandale: true, 'First Choice': true, RiteAway: false, Revive: false, NuBioage: true, ScriptWorks: false },
      'Virginia': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Washington': { Hallandale: true, 'First Choice': false, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'West Virginia': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Wisconsin': { Hallandale: true, 'First Choice': true, RiteAway: true, Revive: true, NuBioage: true, ScriptWorks: false },
      'Wyoming': { Hallandale: true, 'First Choice': false, RiteAway: true, Revive: false, NuBioage: false, ScriptWorks: false },
      'Virgin Islands': { Hallandale: false, 'First Choice': false, RiteAway: false, Revive: false, NuBioage: false, ScriptWorks: false }
    };

    // Global variables
    let medications = [];
    let caMedications = [];

    // Medication descriptions
    function getMedicationDescription(medication) {
      if (!medication) return 'Medication information not available.';
      
      const medLower = medication.toLowerCase();
      
      if (medLower.includes('testosterone cypionate')) return 'Used for TRT to treat low testosterone. Improves energy, muscle, libido. Side effects: acne, hair loss, mood changes.';
      if (medLower.includes('testosterone enanthate')) return 'Long-acting testosterone for HRT. Similar to cypionate. Side effects: acne, hair loss, mood changes.';
      if (medLower.includes('anastrozole')) return 'Reduces estrogen in TRT patients. Prevents gynecomastia. Side effects: joint pain, hot flashes.';
      if (medLower.includes('bi-estrogen')) return 'HRT for menopause symptoms like hot flashes. Side effects: weight gain, blurred vision, tiredness, acne.';
      if (medLower.includes('progesterone')) return 'Supports hormonal balance in HRT. Improves sleep, mood. Side effects: abdominal pain, bloating, blurred vision, nausea.';
      if (medLower.includes('clomiphene') || medLower.includes('clomid')) return 'Stimulates testosterone in men or ovulation in women. Side effects: hot flashes, headaches.';
      if (medLower.includes('estrogen patch')) return 'HRT for menopause. Reduces hot flashes, vaginal dryness. Side effects: bloating, breast tenderness, headaches, nausea.';
      if (medLower.includes('dhea')) return 'Supports hormone production. May improve energy, mood. Side effects: oily skin, acne, hair loss, upset stomach.';
      if (medLower.includes('pregnenolone')) return 'Precursor hormone for others. May aid memory, mood. Side effects: overstimulation, insomnia, irritability, acne, headache.';
      if (medLower.includes('nandrolone')) return 'For joint pain, muscle wasting. Relieves hypogonadal joint pain. Side effects: headaches, acne, diarrhea, edema.';
      if (medLower.includes('l carnitine')) return 'Aids fat burning, energy. For healing, performance. Side effects: stomach upset, heartburn, diarrhea, seizures.';
      if (medLower.includes('sermorelin')) return 'Stimulates growth hormone release. Anti-aging, energy. Side effects: injection site reactions, headache, flushing, nausea.';
      if (medLower.includes('cjc 1295')) return 'Boosts GH for muscle, fat loss. Side effects: headaches, flu-like symptoms, irritability, nausea.';
      if (medLower.includes('ipamorelin')) return 'Growth hormone peptide. Works with CJC 1295. Side effects: headaches, flu-like symptoms.';
      if (medLower.includes('bpc')) return 'Promotes healing, wound repair. For tendons, ligaments. Side effects: unknown in humans, potential injection reactions.';
      if (medLower.includes('tb500') || medLower.includes('tb4')) return 'Aids tissue repair, flexibility. Side effects: fatigue, headaches, dizziness, injection site irritation.';
      if (medLower.includes('sildenafil') || medLower.includes('viagra')) return 'Treats ED by increasing blood flow. Side effects: headache, flushing, nausea, stuffy nose.';
      if (medLower.includes('tadalafil') || medLower.includes('cialis')) return 'Treats ED, longer-lasting. Side effects: headache, flushing, back pain, nausea.';
      if (medLower.includes('pt 141') || medLower.includes('bremelanotide')) return 'Boosts libido, arousal. Side effects: nausea (common), vomiting, flushing, headache.';
      if (medLower.includes('oxytocin')) return 'Enhances bonding, may aid sexual function. Side effects: headache, nausea, vomiting, rapid heartbeat.';
      if (medLower.includes('scream cream')) return 'Topical for female arousal. Side effects: itching, redness, dryness, dizziness, headaches.';
      if (medLower.includes('glutathione')) return 'Antioxidant for detox, skin. Side effects: rash (topical), nausea, abdominal cramps (injections).';
      if (medLower.includes('lipo b')) return 'Fat-burning injection with B vitamins. Side effects: allergic reactions, anxiety, constipation, diarrhea.';
      if (medLower.includes('mic b12') || medLower.includes('bioboost')) return 'Weight loss blend with B12. Side effects: pain at site, nausea, vomiting, diarrhea.';
      if (medLower.includes('vitamin b12')) return 'For energy, deficiency. Side effects: mild diarrhea, itching, swelling sensation.';
      if (medLower.includes('lipo c')) return 'Lipotropic for fat loss. Side effects: pain/swelling at site, nausea, gastrointestinal issues.';
      if (medLower.includes('finasteride')) return 'For hair loss. Blocks DHT. Side effects: sexual dysfunction, depression.';
      if (medLower.includes('minoxidil')) return 'For hair loss. Promotes growth. Side effects: itching, scalp irritation.';
      if (medLower.includes('metformin')) return 'Blood sugar control for weight loss. Side effects: nausea, diarrhea, stomach upset.';
      if (medLower.includes('phentermine')) return 'Appetite suppressant. Side effects: dry mouth, insomnia, increased heart rate.';
      if (medLower.includes('semaglutide')) return 'GLP-1 for weight loss. Side effects: nausea, vomiting, diarrhea.';
      if (medLower.includes('tirzepatide')) return 'Dual GIP/GLP-1 for weight loss. Side effects: nausea, decreased appetite.';
      if (medLower.includes('melatonin')) return 'Sleep hormone supplement. Side effects: drowsiness, headache, dizziness.';
      if (medLower.includes('trazodone')) return 'Sleep aid, antidepressant. Side effects: drowsiness, dry mouth, dizziness.';
      if (medLower.includes('hcg') || medLower.includes('pregnyl')) return 'Human chorionic gonadotropin. Stimulates testosterone. Side effects: headache, irritability, fatigue.';
      if (medLower.includes('gonadorelin')) return 'Stimulates LH/FSH release. Alternative to HCG. Side effects: injection site reactions.';
      if (medLower.includes('enclomiphene')) return 'Selective estrogen receptor modulator. Boosts testosterone. Side effects: hot flashes, headaches.';
      if (medLower.includes('tamoxifen')) return 'SERM for estrogen blocking. Side effects: hot flashes, nausea.';
      if (medLower.includes('exemestane')) return 'Aromatase inhibitor. Reduces estrogen. Side effects: joint pain, fatigue.';
      if (medLower.includes('letrozole')) return 'Aromatase inhibitor. Very potent. Side effects: joint pain, hot flashes.';
      if (medLower.includes('cabergoline')) return 'Dopamine agonist. Reduces prolactin. Side effects: nausea, dizziness.';
      if (medLower.includes('kyzatrex')) return 'Oral testosterone undecanoate. Alternative to injections. Side effects: similar to other testosterone.';
      
      if (medLower.includes('testosterone')) return 'Testosterone replacement therapy. Side effects: acne, hair loss, mood changes.';
      if (medLower.includes('estrogen') || medLower.includes('bi-est')) return 'Estrogen hormone replacement. Side effects: bloating, breast tenderness.';
      if (medLower.includes('vitamin') || medLower.includes('b12')) return 'Vitamin supplementation for energy and health.';
      
      return 'Medication information not available. Please consult your healthcare provider.';
    }

    // Parse CSV manually
    function parseCSV(text) {
      const lines = text.split('\n').map(line => line.trim()).filter(line => line);
      const result = [];
      
      for (let i = 0; i < lines.length; i++) {
        const row = [];
        let current = '';
        let inQuotes = false;
        
        for (let j = 0; j < lines[i].length; j++) {
          const char = lines[i][j];
          
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            row.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        
        row.push(current.trim());
        result.push(row);
      }
      
      return result;
    }

    // Parse medications
    function parseMedications(csvText, isCA) {
      const rows = parseCSV(csvText);
      const meds = [];
      let currentCategory = null;
      let headerIndices = null;
      
      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        if (!row || row.length === 0) continue;
        
        const firstCell = String(row[0] || '');
        
        // Check if this is a category
        if (PATIENT_GOALS.some(goal => firstCell.includes(goal))) {
          currentCategory = PATIENT_GOALS.find(goal => firstCell.includes(goal));
          continue;
        }
        
        // Check if this is the header row
        if (firstCell === 'Medication' || firstCell.toLowerCase().includes('medication')) {
          headerIndices = {
            medication: 0,
            syringes: row.findIndex(h => h && h.toLowerCase().includes('syringe')),
            delivery: row.findIndex(h => h && (h.toLowerCase().includes('delivery') || h.toLowerCase() === 'type')),
            strength: row.findIndex(h => h && h.toLowerCase().includes('strength')),
            quantity: row.findIndex(h => h && h.toLowerCase().includes('quantity')),
            price: row.findIndex(h => h && h.toLowerCase().includes('price')),
            duration: row.findIndex(h => h && h.toLowerCase().includes('duration')),
            pharmacy: row.findIndex(h => h && h.toLowerCase().includes('pharmacy')),
            remarksDosing: row.findIndex(h => h && (h.toLowerCase().includes('remark') || h.toLowerCase().includes('dosing'))),
            description: row.findIndex(h => h && h.toLowerCase().includes('description'))
          };
          continue;
        }
        
        // Skip if we don't have a category yet
        if (!currentCategory || !headerIndices) continue;
        
        // Skip notes and empty rows
        if (firstCell.toLowerCase().includes('note') || 
            firstCell.toLowerCase().includes('standard add on') ||
            firstCell === '$100 CONSULT FEE' ||
            row.filter(cell => cell).length < 2) {
          continue;
        }
        
        // Parse medication
        if (firstCell && firstCell.trim()) {
          const med = {
            category: currentCategory,
            medication: firstCell.trim(),
            syringes: headerIndices.syringes >= 0 ? String(row[headerIndices.syringes] || '') : '',
            delivery: headerIndices.delivery >= 0 ? String(row[headerIndices.delivery] || '') : '',
            strength: headerIndices.strength >= 0 ? String(row[headerIndices.strength] || '') : '',
            quantity: headerIndices.quantity >= 0 ? String(row[headerIndices.quantity] || '') : '',
            price: headerIndices.price >= 0 ? String(row[headerIndices.price] || '') : '',
            duration: headerIndices.duration >= 0 ? String(row[headerIndices.duration] || '') : '',
            pharmacy: headerIndices.pharmacy >= 0 ? String(row[headerIndices.pharmacy] || '') : '',
            remarksDosing: headerIndices.remarksDosing >= 0 ? String(row[headerIndices.remarksDosing] || '') : '',
            description: headerIndices.description >= 0 ? String(row[headerIndices.description] || '') : getMedicationDescription(firstCell.trim()),
            isCA: isCA
          };
          
          if (!med.description || med.description === 'null' || med.description === '') {
            med.description = getMedicationDescription(med.medication);
          }
          
          meds.push(med);
        }
      }
      
      return meds;
    }

    // Filter medications
    function filterMedications(state, goal) {
      const medList = state === 'California' ? caMedications : medications;
      
      let filtered = medList.filter(med => med.category === goal);
      
      if (state !== 'California') {
        const stateShipping = SHIPMENT_MAP[state] || {};
        
        filtered = filtered.filter(med => {
          if (!med.pharmacy || med.pharmacy === 'null' || med.pharmacy.trim() === '') {
            return Object.values(stateShipping).some(ships => ships);
          }
          
          const pharmacies = med.pharmacy.split(',').map(p => p.trim());
          
          if (med.medication.toLowerCase().includes('hcg') || 
              med.medication.toLowerCase().includes('pregnyl') ||
              med.medication.toLowerCase().includes('gonadorelin')) {
            return stateShipping['RiteAway'] || stateShipping['Revive'];
          }
          
          return pharmacies.some(pharmacy => {
            if (pharmacy.includes('Hallandale')) return stateShipping['Hallandale'];
            if (pharmacy.includes('First Choice') || pharmacy.includes('1st Choice')) return stateShipping['First Choice'];
            if (pharmacy.includes('Rite Away') || pharmacy.includes('RiteAway')) return stateShipping['RiteAway'];
            if (pharmacy.includes('Revive')) return stateShipping['Revive'];
            if (pharmacy.includes('NuBioage') || pharmacy.includes('NuBiage')) return stateShipping['NuBioage'];
            return true;
          });
        });
      }
      
      return filtered;
    }

    // Display medications
    function displayMedications(meds, state, goal) {
      const resultsSection = document.getElementById('results-section');
      const noResults = document.getElementById('no-results');
      const header = document.getElementById('results-header');
      const list = document.getElementById('medications-list');
      
      if (meds.length === 0) {
        resultsSection.classList.add('hidden');
        noResults.classList.remove('hidden');
        return;
      }
      
      noResults.classList.add('hidden');
      resultsSection.classList.remove('hidden');
      
      header.textContent = `Available Medications for ${goal} in ${state}`;
      
      list.innerHTML = meds.map(med => `
        <div class="medication-card">
          <h3>${med.medication}</h3>
          
          <div class="medication-grid">
            <div>
              ${med.delivery ? `<p><span class="font-medium">Delivery:</span> ${med.delivery}</p>` : ''}
              ${med.strength ? `<p><span class="font-medium">Strength:</span> ${med.strength}</p>` : ''}
              ${med.quantity ? `<p><span class="font-medium">Quantity:</span> ${med.quantity}</p>` : ''}
              ${med.price ? `<p><span class="font-medium">Price:</span> ${med.price}</p>` : ''}
            </div>
            <div>
              ${med.duration ? `<p><span class="font-medium">Duration:</span> ${med.duration}</p>` : ''}
              ${med.syringes && med.syringes !== 'null' ? `<p><span class="font-medium">Syringes:</span> ${med.syringes}</p>` : ''}
              ${med.pharmacy && med.pharmacy !== 'null' ? `<p><span class="font-medium">Pharmacy:</span> ${med.pharmacy}</p>` : ''}
            </div>
          </div>
          
          ${med.remarksDosing && med.remarksDosing !== 'null' ? `
            <div class="info-box dosing">
              <p class="font-medium">Dosing Instructions:</p>
              <p class="text-muted">${med.remarksDosing}</p>
            </div>
          ` : ''}
          
          ${med.description ? `
            <div class="info-box description">
              <p class="font-medium">Description:</p>
              <p class="text-muted">${med.description}</p>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      const vikingFile = document.getElementById('viking-file');
      const caFile = document.getElementById('ca-file');
      const stateSelect = document.getElementById('state-select');
      const goalSelect = document.getElementById('goal-select');
      
      // Populate states
      STATES.forEach(state => {
        const option = document.createElement('option');
        option.value = state;
        option.textContent = state;
        stateSelect.appendChild(option);
      });
      
      // Populate goals
      PATIENT_GOALS.forEach(goal => {
        const option = document.createElement('option');
        option.value = goal;
        option.textContent = goal;
        goalSelect.appendChild(option);
      });
      
      // File uploads
      vikingFile.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(event) {
            medications = parseMedications(event.target.result, false);
            checkDataLoaded();
          };
          reader.readAsText(file);
        }
      });
      
      caFile.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(event) {
            caMedications = parseMedications(event.target.result, true);
            checkDataLoaded();
          };
          reader.readAsText(file);
        }
      });
      
      // Check if both files loaded
      function checkDataLoaded() {
        if (medications.length > 0 && caMedications.length > 0) {
          document.getElementById('upload-section').classList.add('hidden');
          document.getElementById('lookup-section').classList.remove('hidden');
        }
      }
      
      // State selection
      stateSelect.addEventListener('change', function() {
        const state = this.value;
        if (state) {
          goalSelect.disabled = false;
          document.getElementById('select-goal-message').classList.remove('hidden');
        } else {
          goalSelect.disabled = true;
          goalSelect.value = '';
          document.getElementById('select-goal-message').classList.add('hidden');
          document.getElementById('results-section').classList.add('hidden');
          document.getElementById('no-results').classList.add('hidden');
        }
        
        if (state && goalSelect.value) {
          const filtered = filterMedications(state, goalSelect.value);
          displayMedications(filtered, state, goalSelect.value);
        }
      });
      
      // Goal selection
      goalSelect.addEventListener('change', function() {
        const state = stateSelect.value;
        const goal = this.value;
        
        if (state && goal) {
          document.getElementById('select-goal-message').classList.add('hidden');
          const filtered = filterMedications(state, goal);
          displayMedications(filtered, state, goal);
        }
      });
    });
  </script>
</body>
</html>
